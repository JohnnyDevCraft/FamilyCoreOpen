@using System
@using System.Globalization
@using System.Linq.Expressions
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components

<div class="mb-4">
  <label class="block text-sm mb-1 text-[color:var(--color-text-muted-dark)]">@LabelText</label>
  <div class="relative">
    <input type="number"
           class="w-full px-3 py-2 pr-10 rounded-md border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary-400)]"
           value="@DisplayValue"
           step="@StepString"
           placeholder="@PlaceholderText"
           disabled="@Disabled"
           @oninput="OnInputAsync" />
    <span class="absolute inset-y-0 right-3 flex items-center text-sm text-[color:var(--color-text-muted-dark)]">%</span>
  </div>
</div>

@code {
    [Parameter] public string LabelText { get; set; } = "";
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public string PlaceholderText { get; set; } = "";
    [Parameter] public int Precision { get; set; } = 2;

    [Parameter] public decimal? Value { get; set; } // stored as fraction (0.15 = 15%)
    [Parameter] public EventCallback<decimal?> ValueChanged { get; set; }
    [Parameter] public Expression<Func<decimal?>> ValueExpression { get; set; }

    string StepString => Precision <= 0 ? "1" : $"0.{new string('0', Math.Max(0, Precision - 1))}1";
    string DisplayValue => Value.HasValue
        ? Math.Round(Value.Value * 100, Precision, MidpointRounding.AwayFromZero).ToString($"F{Precision}", CultureInfo.InvariantCulture)
        : "";

    async Task OnInputAsync(ChangeEventArgs e)
    {
        var raw = e.Value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(raw))
        {
            Value = null;
            await ValueChanged.InvokeAsync(null);
            return;
        }

        if (decimal.TryParse(raw, NumberStyles.Number, CultureInfo.InvariantCulture, out var percent))
        {
            var fraction = percent / 100m;
            if (Precision >= 0)
            {
                fraction = Math.Round(fraction, Precision, MidpointRounding.AwayFromZero);
            }

            Value = fraction;
            await ValueChanged.InvokeAsync(fraction);
        }
    }
}
