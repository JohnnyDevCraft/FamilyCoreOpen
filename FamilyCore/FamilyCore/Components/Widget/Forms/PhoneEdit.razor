@using System
@using System.Linq
@using System.Linq.Expressions
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components

<div class="mb-4">
  <label class="block text-sm mb-1 text-[color:var(--color-text-muted-dark)]">@LabelText</label>
  <input class="w-full px-3 py-2 rounded-md border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[color:var(--color-primary-400)]"
         placeholder="@PlaceholderText"
         disabled="@Disabled"
         value="@DisplayValue"
         @oninput="OnInputAsync" />
</div>

@code {
    [Parameter] public string LabelText { get; set; } = "";
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public string PlaceholderText { get; set; } = "";

    [Parameter] public string Value { get; set; }
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public Expression<Func<string>> ValueExpression { get; set; }

    string DisplayValue => FormatPhone(Value);

    async Task OnInputAsync(ChangeEventArgs e)
    {
        var raw = e.Value?.ToString() ?? "";
        var digits = new string(raw.Where(char.IsDigit).ToArray());
        if (digits.Length > 10) digits = digits[..10];

        Value = digits;
        await ValueChanged.InvokeAsync(digits);
        StateHasChanged();
    }

    static string FormatPhone(string raw)
    {
        if (string.IsNullOrEmpty(raw)) return "";
        var digits = new string(raw.Where(char.IsDigit).ToArray());
        return FormatPhoneFromDigits(digits);
    }

    static string FormatPhoneFromDigits(string digits)
    {
        if (string.IsNullOrEmpty(digits)) return "";
        if (digits.Length <= 3) return $"({digits}";
        if (digits.Length <= 6) return $"({digits[..3]}){digits[3..]}";
        return $"({digits[..3]}){digits.Substring(3,3)}-{digits[6..]}";
    }
}
